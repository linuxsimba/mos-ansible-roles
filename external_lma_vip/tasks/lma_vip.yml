- name: check if internal_lma_vip is defined
  fail: msg="internal_lma_vip is not defined. check it on a LMA device crm resource show "
  when: internal_lma_vip == ""

- name: create ansible fact directory
  file: path=/etc/ansible/facts.d state=directory

- name: add ansible local fact lma vip file
  copy: src=external_vip.py dest=/etc/ansible/facts.d/external_vip.fact mode=0755 owner=root

- name: Get local facts
  setup: filter="ansible_local*"

- name: get the br_mgmt ip for all lma hosts
  setup: filter="ansible_br_mgmt*"
  delegate_to: "{{item}}"
  with_items: " {{ groups['lma'] }}"
  delegate_facts: true

- name: get the hostname for all lma hosts
  setup: filter="ansible_hostname*"
  delegate_to: "{{item}}"
  with_items: " {{ groups['lma'] }}"
  delegate_facts: true

- name: create influxdb haproxy cfg on the controllers
  template:  src=800-influxdb.cfg.j2 dest=/etc/haproxy/conf.d/800-influxdb.cfg

- name: create grafana haproxy cfg on the controllers
  template:  src=801-grafana.cfg.j2 dest=/etc/haproxy/conf.d/801-grafana.cfg

- name: create elasticsearch haproxy cfg on the controllers
  template:  src=920-elasticsearch-rest.cfg.j2 dest=/etc/haproxy/conf.d/920-elasticsearch-rest.cfg

- name: create kibana haproxy cfg on the controllers
  template:  src=921-kibana.cfg.j2 dest=/etc/haproxy/conf.d/921-kibana.cfg

- name: create nagios haproxy cfg on the controllers
  template:  src=303-nagios.cfg.j2 dest=/etc/haproxy/conf.d/303-nagios.cfg
